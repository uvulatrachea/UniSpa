services:
    nginx:
        image: nginx:1.25-alpine
        container_name: unispa-nginx
        ports:
            - '8080:80'
        volumes:
            - '.:/app'
            - './docker/nginx/nginx.conf:/etc/nginx/nginx.conf'
        depends_on:
            - php

    php:
        build:
            context: .
            dockerfile: DockerFile
        container_name: unispa-php
        working_dir: /var/www/html
        command: php artisan serve --host=0.0.0.0 --port=80
        ports:
            - '8000:80'
        volumes:
            - '.:/var/www/html'
        environment:
            APP_ENV: local
            APP_DEBUG: 'true'
            DB_CONNECTION: pgsql
            DB_HOST: pgsql
            DB_PORT: 5432
            DB_DATABASE: unispa
            DB_USERNAME: sail
            DB_PASSWORD: password
        depends_on:
            pgsql:
                condition: service_healthy

    pgsql:
        image: postgres:16-alpine
        container_name: unispa-pgsql
        ports:
            - '5432:5432'
        environment:
            POSTGRES_DB: unispa
            POSTGRES_USER: sail
            POSTGRES_PASSWORD: password
        volumes:
            - pgsql-data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U sail -d unispa"]
            interval: 5s
            timeout: 5s
            retries: 10

volumes:
    pgsql-data:
